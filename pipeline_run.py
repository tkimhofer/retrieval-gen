from services.chunking import Ratssiztung
from services.llm_client import LLMRun
from services.embedding import Transformer, Retriever
from openai import OpenAI
import os, json
from dotenv import load_dotenv
load_dotenv('.env')


### process pdf data -> extract chunks
path_file = 'corpus/source_pdfs/20250224_duisburg_ratssitzung_öffentlich.pdf'
ratprot = Ratssiztung(pdf_path=path_file)
ratprot.extract_tops()

### set up llm client and generate chunk summaries
api_key = os.getenv('GPT_API_KEY')
client = OpenAI(api_key=api_key)
llm_prompt = "./core/prompts/top_prompt.txt"
llm_client = LLMRun(client, path_prompt=llm_prompt)


### get chunks
dir_text = 'corpus/text/20250224_duisburg_ratssitzung_öffentlich/'
text_chunks = []
for file in os.listdir(dir_text):
    if ('top_' in file) and not (file == 'top_1.jsonl'):
        fpath = os.path.join(dir_text, file)
        with open(fpath, 'r') as f:
            top = json.load(f)

        chunk = f"{top['topic']}: {top['content1']}"
        text_chunks.append({top['top_nr']: chunk})

### chunk inference
model='gpt-5-nano'
pars = {"temperature": 0.1}
## rough costs estimate: 0.40 Euro per 50 TOPs for model gpt-5-nano

for c in text_chunks:
    top_id = list(c.keys())[0]
    top_text = list(c.values())[0]
    if top_id == '37': continue
    print(top_id)
    llm_client.run(model=model, top_id=top_id, meeting_date='20250224', top_text=top_text, pars=pars)

# self = llm_client
# ### send request for each chunk
# top = 'Anfrage der FDP-Fraktion GEBAG – Wie viele Millionen aus Steuergeld sollen noch folgen? Inhalt Vorbemerkung zur Anfrage Die Duisburger Stadttochter GEBAG ist einmal mehr ins Zentrum öffentlicher Aufmerksam- keit gerückt – und erneut nicht im positiven Sinne. Nach dem Küppersmühlen-Desaster steht die Gesellschaft abermals am Rande der Zahlungsunfähigkeit. Mit der nun öffentlich gewor- denen Notwendigkeit einer Rettung in Höhe von rund 165 Millionen Euro, finanziert maßgeb- lich aus Mitteln der Stadt Duisburg, stellt sich nicht nur die Frage nach der künftigen Hand- lungsfähigkeit der GEBAG, sondern auch nach der Verantwortung innerhalb von Verwaltung, Geschäftsführung und Politik. Es ist ein Skandal, dass trotz positiver Geschäftszahlen für das Jahr 2023, noch im Frühjahr 2025 von einer „präventiven Umstrukturierung“ gesprochen wurde, während Wirtschaftsprü- fer und Verwaltung bereits auf eine massive bilanzielle Schieflage und drohende Insolvenz hinwiesen. Nun offenbart sich, dass Grundstückswerte teils dramatisch überbewertet waren, was nicht nur zur bilanziellen Kernschmelze führte, sondern möglicherweise auch zu einer fehlerhaften Steuerfestsetzung mit erheblichen Folgekosten für die Allgemeinheit. Diese Entwicklung ist nicht nur ein weiterer Rückschlag für die Glaubwürdigkeit kommunaler Wirtschaftspolitik, sondern weckt auch Zweifel am Controlling, an der politischen Aufsicht sowie an der redlichen Geschäftsführung innerhalb des Stadtkonzerns. Wenn eine kommu- nale Wohnungsbaugesellschaft trotz Warnzeichen derart in Schieflage gerät, besteht der Verdacht systemischer Fehlentwicklungen – und womöglich rechtlicher Versäumnisse. Die Bürgerinnen und Bürger haben ein Recht auf Transparenz. Die Ratsmitglieder haben die Pflicht, zu kontrollieren und nicht bloß abzunicken. Die FDP-Fraktion bittet daher um Beantwortung der folgenden Fragen: 1. Grundstücksbewertungen und Bilanzierung: Wann und durch wen wurden die Grundstückswerte der GEBAG Flächenentwicklungsge- sellschaft zuletzt bewertet und wie ist sichergestellt, dass die damaligen Buchwerte den tatsächlichen Marktwerten entsprachen? 2. Prüfung auf Insolvenzverschleppung: Liegen der Verwaltung Hinweise darauf vor, dass Verantwortliche der GEBAG oder der FE eine mögliche Insolvenz bereits vor der Offenlegung im Rahmen des Jahresabschlusses 2024 hätten erkennen können oder müssen (§ 15a InsO)? Fortsetzung nächste SeiteFortsetzung Anfrage 3. Bilanzfälschung bzw. fehlerhafte Bilanzierung: Wurden in den Jahren 2021 bis 2023 aufgrund der überhöhten Grundstückswerte Gewin- ne bilanziert, die nunmehr als nicht realistisch erscheinen? Wurden daraufhin Steuern ab- geführt, die bei richtiger Bewertung nicht entstanden wären? 4. Haftung für überhöhte Steuerzahlungen: Welche rechtlichen Möglichkeiten sieht die Stadt, steuerrechtliche Korrekturen gemäß §§ 172 ff. AO zu beantragen, wenn sich herausstellt, dass zu Unrecht zu hohe Gewinne aus- gewiesen und damit zu hohe Steuerzahlungen geleistet wurden? 5. Finanzielle Haftung: Wer haftet – zivil- oder strafrechtlich – für etwaige Schäden, die durch eine falsche Bewer- tung oder verspätete Offenlegung der wirtschaftlichen Lage entstanden sind, insbesonde- re im Hinblick auf überhöhte Steuerzahlungen oder Insolvenzrisiken? 6. Steuerliche Auswirkungen der Vermögensübertragungen: Inwieweit sind durch die nun vollzogene Teilvermögensübertragung grunderwerbsteuerli- che Risiken entstanden, insbesondere im Hinblick auf die Nachbehaltensfristen gem. § 6a GrEStG für frühere Grundstücksübertragungen (z. B. 2019 und 2020)? 7. Kontrolle und Verantwortung innerhalb des Stadtkonzerns: Wie wurde das interne Controlling innerhalb des Stadtkonzerns organisiert, und warum konnten so erhebliche wirtschaftliche Schieflagen bei der GEBAG/FE über Jahre hinweg unentdeckt bleiben? 8. Kommunikationspolitik gegenüber dem Rat: Warum wurde der Rat der Stadt noch im Februar 2025 von der Verwaltung und Geschäfts- führung nicht über die drohende Insolvenzgefahr informiert, obwohl intern offenbar bereits seit der Jahresabschlussprüfung 2024 massive Risiken bekannt waren? 9. Personalpolitik und Verantwortung: Welche Rolle spielten die ehemaligen Geschäftsführer Bernd Wortmeyer und Winand Schneider bei der Entwicklung der aktuellen Lage? Sind gegen sie disziplinarrechtliche oder sonstige juristische Schritte eingeleitet worden? 10.Künftige Risikoüberwachung: Welche konkreten Maßnahmen plant die Stadt, um vergleichbare wirtschaftliche Fehlent- wicklungen bei stadteigenen Gesellschaften künftig frühzeitig zu erkennen und zu verhin- dern (z. B. Einführung eines Konzerncontrollings oder Frühwarnsystems)? Beratungsergebnis Antwort der Verwaltung, siehe nächste Seite. Stadtdirektor Murrack beantwortete die Anfrage wie folgt: Zuallererst wolle er sich herzlich bei allen Kolleginnen und Kollegen, insbesondere den Mit- arbeiterinnen und Mitarbeitern der GEBAG und der Kämmerei bedanken, die intensiv an den Themen gearbeitet haben. Nach wie vor sei er der festen Überzeugung, dass es die richtige Entscheidung des Rates und der GEBAG gewesen sei, die Flächen für die Stadt zu sichern. Für die Stadtentwicklung sei es elementar gewesen, dass man Zugriff auf diese Flächen gehabt habe und auch zu- künftig noch haben werde. Er habe Verständnis dafür, dass es kritische Fragen aus dem Rat und den Medien gebe. Er bemühe sich die aufgekommenen Fragen wahrheitsgemäß und vernünftig zu beantworten. Die Vorlagen und auch die Beantwortung der Anfrage werden in öffentlicher Sitzung behan- delt, da seiner Meinung nach das Thema in der Öffentlichkeit diskutiert werden müsse. Die Flächenentwicklung bei der GEBAG habe einen guten Start gehabt. Die ersten Flächen- verkäufe bei Sechs-Seen-Wedau seien positiver als ursprünglich angenommen gewesen. Was die Betreuung der städtischen Kitas angehe, habe die GEBAG Pionierarbeit geleistet. Das, was heute zum Beschluss stehe, bedeute nicht, dass die Arbeit der GEBAG in den letz- ten Jahren schlecht gewesen sei. Die GEBAG habe viele wichtige und gute Impulse gesetzt, die auch in Zukunft fortbestehen würden. Durch die Coronakrise, den Ukrainekrieg, die steigenden Zinsen und Baukosten und die Zu- rückhaltung der Investoren sei die Flächenentwicklung an seine Grenzen gestoßen. Das habe sei nicht nur in Duisburg passiert, sondern habe Flächenentwicklungsprojekte in ganz Deutschland getroffen. Er sehe selbstkritisch ein, dass diese Situation mit mehr Vehemenz auch früher hinterfragt werden hätte können. Die Verwaltung und die Kontrollgremien hätten dies getan. Die Antworten seien steht unisono gewesen, dass es kein Problem gebe. Erst mit dem Weggang von Herrn Wortmeyer sei die Situation klarer geworden. Der Prozess habe lange gedauert, weswegen es Kritik gegeben habe, warum der Rat und die Öffentlichkeit nicht früher informiert worden seien. Sobald klar gewesen sei, wie groß das Problem sei und wie die Lösung aussehen könne, sei man damit an die Öffentlichkeit gegangen und habe den Aufsichtsrat informiert. Der Abwertungsbedarf der GEBAG FE mit dem Jahresabschluss 2024 sei nicht der GEBAG anzulasten. Der Anlass im letzten Jahr über den Abwertungsbedarf zu diskutieren habe sich nicht geboten. Doch der Abwertungsbedarf wäre auch im letzten Jahr ähnlich groß gewor- den. Die Verwaltung habe eine positive Tendenz sowohl für die ‚GEBAG als auch für die GEBAG FE erarbeitet. Von den 165 Mio. Euro seien 123,5 Mio. Euro investiver Art. Sie wir- ken wertsteigernd und würden in der Bilanz nicht zu einem Verlust führen, sondern das Vermögen an der GEBAG erhöhen. Die GEBAG werde auf eine Eigenkapitalquote von 19 % kommen, womit man im Rating bei den Banken eine der oberen Kategorien erreiche. 61,5 Mio. Euro der 165 Mio. Euro seien für die Umwandlung eines Kredites in Eigenkapital. Es koste die Stadt lediglich 3 Mio. Euro Zinsen pro Jahr, die man im kommunalen Haushalt nicht mehr vereinnahmen könne. Die 41,5 Mio. Euro, die konsumtiv für Maßnahmen fällig werden würden, seien ergebniswirk- sam. Der Betrag sei auszugleichen durch einen glücklichen Gewerbesteuereffekt. Er ermög- lich der Verwaltung diese Maßnahme zu machen ohne eine Haushaltssperre aussprechen zu müssen oder einen Nachtragshaushalt aufzustellen. Zu Frage 1: Bei der Erstellung des Jahresabschlusses 2023 wurden externe Gutachten (Gutachterfirma Schmidt Immowert aus Dortmund) auf den Stichtag 31.12.2023 für die Überprüfung der bi- lanzierten Grundstückswerte herangezogen. Die Grundstücksbewertungen wurden seinerzeit von den Wirtschaftsprüfern der GEBAG FE im Rahmen der Jahresabschlussprüfung nicht beanstandet. In der FE waren in den Jahren 2022 und 2023 die Verkaufstätigkeiten und die Verkaufspreise deutlich positiver als aktuell. Die bilanzierten Werte sind damit aus damaliger Sicht korrekt, was in jedem Jahr durch die Abschlussprüfer bestätigt wurde. Zu Frage 2: Es liegt aktuell kein Insolvenzgrund vor, so dass keinerlei Hinweise auf Insolvenzverschlep- pung bestehen. Zahlungsunfähigkeit liegt bei beiden Gesellschaften nicht vor. Seit dem 31.3.2025 ist aus einem Gutachten einer externen Beratung bekannt, dass die Buchwerte der drei Areale Du- isburger Dünen, 6-Seen-Wedau und TQ Wedau auf ihre Verkehrswerte zum 31.12.2024 ab- zuschreiben sind. Die Abschreibung führt zu einer bilanziellen Überschuldung der FE. Da die Geschäftsführung aufgrund der bevorstehenden Ratsbeschlüsse vom heutigen Tag aller- dings von einer Fortführung des Unternehmens für mehr als 12 Monate ausgeht, liegt keine insolvenzrechtliche Überschuldung und damit kein Insolvenzgrund vor. Zu Frage 3: Bei der GEBAG gibt es erhebliche steuerliche Verlustvorträge (GewSt und KSt) aus Vorjah- ren, sodass dort auch bei Gewinnen sehr geringe Steuerbeträge anfallen. In der FE wurde in den Jahren 2022 und 2023 Gewinne erwirtschaftet, weil zu der Zeit die Verkaufstätigkeiten und die Verkaufspreise deutlich positiver waren als aktuell. Die bilanzier- ten Werte und Ergebnisse sind damit aus damaliger Sicht korrekt, was in jedem Jahr durch die Abschlussprüfer bestätigt wurde. Die Jahresergebnisse nach HGB sowie die Steuerpositionen in der GuV der Jahre 2021 bis 2023 sind der nachfolgenden Datei zu entnehmen: In Mio. EUR Jahresergebnis HGB (+) Gewinn / (-) Verlust Ertragsteuern (+) Ertrag / (-) Aufwand GEBAG GmbH FE GEBAG GmbH FE 2021 10,46 -0,29 -0,29 0,00 2022 8,40 0,73 0,04 -0,05 2023 1,88 1,27 0,26 -0,65 Summe 20,74 1,71 0,01 -0,70 Zu Frage 4: In Anknüpfung an die Ausführungen zu Punkt 3 ergibt sich, dass zu keinem Zeitpunkt unzu- treffend erhöhte Gewinne ausgewiesen wurden. Folglich bestand auch keine Grundlage für überhöhte Steuerzahlungen, sodass die Voraussetzungen für steuerrechtliche Korrekturen gemäß §§ 172 ff. AO derzeit nicht erkennbar sind. Zu Frage 5: Unter Berücksichtigung der Ausführungen in den Punkten 2, 3 und 9 wird deutlich, dass nach dem Wechsel der Geschäftsführung der GEBAG alle Verantwortlichen mit Kenntnis der negativen wirtschaftlichen Entwicklung der GEBAG sowie der GEBAG FE unverzüglich die erforderlichen Maßnahmen eingeleitet haben, um die wirtschaftliche Stabilität beider Gesell- schaften zu sichern. Ziel der in den Beschlussvorlagen dargestellten und geplanten Schritte ist, die insolvenzrechtliche Risiken, insbesondere bei der GEBAG FE, abzuwenden und den städtischen Einfluss auf die Grundstücke und die Gebäude sowohl der GEBAG als auch der GEBAG FE sicherzustellen. Zu Frage 6: Die geplante Teilvermögensübertragung löst keine Grunderwerbsteuer aus. Die Nachbehal- tensfristen der Grundstückstransaktionen aus 2019 und 2020 von der GEBAG auf die GE- BAG FE werden jedoch gerissen, so dass die Grunderwerbsteuer aus 2019/2020 durch die FE nachträglich bezahlt werden muss (ca. EUR 5,5 Mio.). Zu Frage 7: Das interne Controlling innerhalb des Stadtkonzerns basiert auf den durch die jeweilige Ge- sellschaft aufbereiteten und durch die Wirtschaftsprüfungsgesellschaften bestätigten Daten und ist auf eine enge, kontinuierliche Zusammenarbeit zwischen der Geschäftsführung der jeweiligen Gesellschaft, seinem Aufsichtsrat und der Gesellschafterin – der Stadt Duisburg – ausgerichtet. Zu jedem Zeitpunkt erfolgt eine enge Abstimmung der durch die Gesellschaften vorgelegten Wirtschaftspläne mit der Gesellschafterin. Darüber hinaus werden in den durch die Gesellschaften regelmäßig erstellten Quartalsberichte sowie im Rahmen der Jahresab- schlüsse potenzielle Chancen und Risiken analysiert und bewertet. Die aktuell eingetretene wirtschaftliche Schieflagen ist maßgeblich durch externe wirtschaftli- che Faktoren getrieben. Im Zusammenhang mit der GEBAG und insbesondere der GEBAG FE wird auf die diesbezüglichen Ausführungen in den vorangegangenen Punkten verwiesen. Vor dem Hintergrund der aktuellen Entwicklungen werden die Controlling- und Steuerungs- strukturen mit Unterstützung von externen Beratern gezielt weiterentwickelt, um eine frühzei- tigere Risikoerkennung zu gewährleisten. So gab es bereits die Übereinkunft mit der neuen Geschäftsführung, dass es ein kontinuierliches Risikocontrolling eingeführt wird und über dieses regelmäßig im Aufsichtsrat berichtet wird. Zu Frage 8: Im Februar 2025 lagen die wesentlichen Informationen, insbesondere das KPMG-Gutachten zur Grundstücksbewertung bei der FE, noch nicht abschließend vor bzw. konnten noch nicht vollständig analysiert werden. Vor der Entwicklung belastbarer Lösungsansätze bestand da- her keine abschließende Bewertungsgrundlage. Diese liegt nun vor und daher ist jetzt der richtige Zeitpunkt erst den Aufsichtsrat (am 29.4.) und mit den Vorlagen den Rat (am 30.4.) zu informieren. Zu Frage 9: Herr Winand Schneider ist kein ehemaliger, sondern der aktuelle Geschäftsführer. Herr Schneider hat die entscheidenden Anstöße zur Aufklärung gegeben, als die Liquiditätslücken innerhalb der GEBAG vermutet wurden. Zu Frage 10: Innerhalb der GEBAG wird die organisatorische Aufstellung komplett überarbeitet. Die Über- wachungs- und Steuerungsfunktionen werden deutlich ausgeweitet. Erste Schritte in diese Richtung wurden umgehend umgesetzt, z.B. Monatsabschlüsse, Liquiditätsplanungen etc. Ergänzend ist vorgesehen, entsprechende Regelungen und Berichtspflichten auch satzungs- rechtlich zu verankern. Mit der Neuausrichtung der Zielstruktur der GEBAG FE wird zudem eine Erweiterung der Controlling- und Governance-Strukturen einhergehen. Ein zentrales Element ist hierbei die Einrichtung eines eigenen Aufsichtsrats für die GEBAG FE, um eine unabhängige und kontinuierliche Kontrolle sicherzustellen. Darüber hinaus wird die GEBAG künftig ihren Fokus verstärkt auf das Kerngeschäft der Wohnungswirtschaft legen. Diese strategische Konzentra- tion erhöht die Steuerbarkeit der Gesellschaft und reduziert zugleich die Anfälligkeit für ex- terne wirtschaftliche Risiken, insbesondere aus dem Bereich der komplexen Projektentwick- lung.“'
#
# # model='gpt-5-mini'
# # model='gpt-5-nano'
# model = 'gpt-5'
#
#
# top_id='15'
# meeting_date='06.05.2025'
# top_text=top
# pars = {"temperature": 0.2}

#### chunk, transform, calc vector similiarity (each for text & top summary)
tform = Transformer(model_name="BAAI/bge-m3")
tform.run(path='corpus/chunks', pattern='v0.1_gpt-5-nano')
# %TODO: save faiss and payloads in corpus/embeddings

#### prep query and return payloads with highest similarities (text and top summary)
## test this, e.g., recall
retr = Retriever(
    transformer=tform.model,
    simMat_dense=tform.index_chunk,
    simMat_top=tform.index_top,
    pl_dense=tform.chunk_payloads,
    pl_top=tform.top_payloads
)

q = "welche themen wurden bzgl. der kommunalen wärmeplanung besprochen?"
infos = retr.search_dense(q)

### pass query and retrieved data on to llm model


### stream llm response to user
